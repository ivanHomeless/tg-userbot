#!/bin/bash

# ============================================
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
# ============================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "============================================"
echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –±–æ—Ç–∞ —Å PostgreSQL"
echo "============================================"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ============================================
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
# ============================================
echo ""
echo "üìå –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Python..."

if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python 3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+${NC}"
    exit 1
fi

PYTHON_VERSION=$(python3 --version | cut -d" " -f2 | cut -d"." -f1-2)
echo -e "${GREEN}‚úÖ Python $PYTHON_VERSION –Ω–∞–π–¥–µ–Ω${NC}"

# ============================================
# 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# ============================================
echo ""
echo "üìå –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

if [ ! -d "venv" ]; then
    python3 -m venv venv
    echo -e "${GREEN}‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  venv —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º${NC}"
fi

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è venv
source venv/bin/activate

# ============================================
# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# ============================================
echo ""
echo "üìå –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

pip install --upgrade pip > /dev/null
pip install -r requirements.txt

echo -e "${GREEN}‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"

# ============================================
# 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫
# ============================================
echo ""
echo "üìå –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫..."

mkdir -p app/models
mkdir -p app/database
mkdir -p app/services
mkdir -p alembic/versions
mkdir -p data
mkdir -p logs
mkdir -p tmp_media

# –°–æ–∑–¥–∞–Ω–∏–µ __init__.py
touch app/__init__.py
touch app/models/__init__.py
touch app/database/__init__.py
touch app/services/__init__.py

echo -e "${GREEN}‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞${NC}"

# ============================================
# 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env
# ============================================
echo ""
echo "üìå –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env..."

if [ ! -f ".env" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo ""
    echo "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
    echo ""
    
    read -p "API_ID (–æ—Ç https://my.telegram.org): " API_ID
    read -p "API_HASH: " API_HASH
    read -p "PHONE (—Ñ–æ—Ä–º–∞—Ç +7...): " PHONE
    read -p "DEST (–∫–∞–Ω–∞–ª –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä @channel): " DEST
    echo ""
    read -p "DATABASE_URL (Enter –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ PostgreSQL): " DATABASE_URL
    
    if [ -z "$DATABASE_URL" ]; then
        DATABASE_URL="postgresql+asyncpg://botuser:secure_password@localhost:5432/telegram_bot"
    fi
    
    cat > .env << EOF
# ============================================
# TELEGRAM AUTH
# ============================================
API_ID=$API_ID
API_HASH=$API_HASH
PHONE=$PHONE
DEST=$DEST

# ============================================
# POSTGRESQL DATABASE
# ============================================
DATABASE_URL=$DATABASE_URL

# ============================================
# AI PROVIDER
# ============================================
AI_PROVIDER=openrouter
OPENROUTER_API_KEY=your_key_here
MODEL=tngtech/deepseek-r1t2-chimera:free

# ============================================
# BOT SETTINGS
# ============================================
POST_DELAY=10
EOF
    
    echo -e "${GREEN}‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å AI –∫–ª—é—á–∏ –≤ .env!${NC}"
else
    echo -e "${GREEN}‚úÖ .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç${NC}"
fi

# ============================================
# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL
# ============================================
echo ""
echo "üìå –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL..."

if command -v psql &> /dev/null; then
    echo -e "${GREEN}‚úÖ PostgreSQL CLI –Ω–∞–π–¥–µ–Ω${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  psql –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω${NC}"
fi

# ============================================
# 7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# ============================================
echo ""
echo "üìå –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ Alembic..."

if [ ! -f "alembic.ini" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  alembic.ini –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤${NC}"
else
    echo -e "${GREEN}‚úÖ Alembic –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
fi

# ============================================
# 8. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
# ============================================
echo ""
echo "üìå –®–∞–≥ 8: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."

read -p "–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é? (y/n): " CREATE_MIGRATION

if [ "$CREATE_MIGRATION" == "y" ]; then
    alembic revision --autogenerate -m "Initial schema"
    echo -e "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞${NC}"
    
    read -p "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫ –ë–î? (y/n): " APPLY_MIGRATION
    
    if [ "$APPLY_MIGRATION" == "y" ]; then
        alembic upgrade head
        echo -e "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞${NC}"
    fi
fi

# ============================================
# 9. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
# ============================================
echo ""
echo "============================================"
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "============================================"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo ""
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env (–æ—Å–æ–±–µ–Ω–Ω–æ AI –∫–ª—é—á–∏)"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:"
echo ""
echo -e "${GREEN}   source venv/bin/activate${NC}"
echo -e "${GREEN}   python main.py${NC}"
echo ""
echo "============================================"

# –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è venv
deactivate
