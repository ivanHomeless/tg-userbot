# üì° Telegram Content Aggregator Bot

Userbot –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤, —Ä–µ—Ä–∞–π—Ç–∞ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ AI –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ —Ü–µ–ª–µ–≤–æ–π –∫–∞–Ω–∞–ª.

–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ userbot –Ω–∞ [Telethon](https://github.com/LonamiWebs/Telethon) ‚Äî –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞ —á–µ—Ä–µ–∑ BotFather.

## ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ö–∞–Ω–∞–ª—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Üí –°–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí –û—á–µ—Ä–µ–¥—å (PostgreSQL) ‚Üí AI-—Ä–µ—Ä–∞–π—Ç ‚Üí –ü—É–±–ª–∏–∫–∞—Ü–∏—è
```

1. üì• **–°–±–æ—Ä** ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `NewMessage` –∏–∑ –∫–∞–Ω–∞–ª–æ–≤-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ê–ª—å–±–æ–º—ã (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ —Å –æ–¥–Ω–∏–º `grouped_id`) –±—É—Ñ–µ—Ä–∏–∑–∏—Ä—É—é—Ç—Å—è 3 —Å–µ–∫—É–Ω–¥—ã –∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –µ–¥–∏–Ω—ã–π –ø–æ—Å—Ç.
2. ‚úçÔ∏è **–†–µ—Ä–∞–π—Ç** ‚Äî —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AI (OpenRouter / DeepSeek / Gemini). –î–ª—è –∞–ª—å–±–æ–º–æ–≤ —Ç–µ–∫—Å—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –∏ —Ä–µ—Ä–∞–π—Ç—è—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑.
3. üì§ **–ü—É–±–ª–∏–∫–∞—Ü–∏—è** ‚Äî –≥–æ—Ç–æ–≤—ã–µ –ø–æ—Å—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ü–µ–ª–µ–≤–æ–π –∫–∞–Ω–∞–ª —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º.

### ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

-**–ê–ª—å–±–æ–º—ã** ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞ —Ñ–æ—Ç–æ –∏–∑ —Ä–∞–∑–Ω—ã—Ö Data Center Telegram (–æ–±—Ö–æ–¥ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –±–∞–≥–æ–≤ Telethon) -**Orphan media** ‚Äî –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∂–¥—ë—Ç –ø–æ–¥–ø–∏—Å—å –¥–æ 20 —Å–µ–∫—É–Ω–¥, –∑–∞—Ç–µ–º –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å -**Caption overflow** ‚Äî –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –≤ caption, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º -**–ë–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤** ‚Äî —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ file reference –æ—Ç Telegram, –º–µ–¥–∏–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ -**–ú—É–ª—å—Ç–∏-–ø—Ä–æ–≤–∞–π–¥–µ—Ä AI** ‚Äî —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π –∏ fallback –º–µ–∂–¥—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ -**Graceful shutdown** ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ SIGINT/SIGTERM

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- PostgreSQL 15+
- Docker (–¥–ª—è –ë–î) –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π PostgreSQL
- Telegram API credentials ([my.telegram.org](https://my.telegram.org))
- API-–∫–ª—é—á AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
git clone https://github.com/<your-username>/tg-userbot.git
cd tg-userbot

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (venv, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, .env, –º–∏–≥—Ä–∞—Ü–∏–∏)
bash setup.sh

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
docker-compose up -d          # PostgreSQL –Ω–∞ –ø–æ—Ä—Ç—É 5433
alembic upgrade head           # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```

### 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# Telegram (https://my.telegram.org)
API_ID=12345678
API_HASH=your_api_hash
PHONE=+79001234567
DEST=@your_channel

# PostgreSQL
DATABASE_URL=postgresql+asyncpg://botuser:password@localhost:5433/telegram_bot

# AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä: openrouter | deepseek | gemini
AI_PROVIDER=openrouter
OPENROUTER_API_KEY=sk-or-...
MODEL=tngtech/deepseek-r1t2-chimera:free

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
POST_DELAY=10           # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏ (—Å–µ–∫)
CAPTION_LIMIT=1024      # –õ–∏–º–∏—Ç caption (1024 / 2048 –¥–ª—è Premium)
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

```bash
python -m scripts.add_sources_from_links @channel_name
python -m scripts.add_sources_from_ids data/sources_ids.txt
python -m scripts.fetch_channel_info --list    # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞
```

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫

```bash
source venv/bin/activate
python main.py
```

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
main.py                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, graceful shutdown
app/
‚îú‚îÄ‚îÄ bot_logic.py                 # NewMessage handler + 4 —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∏
‚îú‚îÄ‚îÄ ai.py                        # –ú—É–ª—å—Ç–∏-–ø—Ä–æ–≤–∞–π–¥–µ—Ä AI —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π
‚îú‚îÄ‚îÄ config.py                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ .env
‚îú‚îÄ‚îÄ prompts.py                   # –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ—Ä–∞–π—Ç–∞
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ collector.py             # –°–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞–ª—å–±–æ–º–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ processor.py             # –†–µ—Ä–∞–π—Ç, —Å–±–æ—Ä–∫–∞ –ø–æ—Å—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ publisher.py             # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –∫–∞–Ω–∞–ª
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ source.py                # –ö–∞–Ω–∞–ª—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ message.py               # –û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ post.py                  # –ü–æ—Å—Ç—ã –∏ –º–µ–¥–∏–∞
‚îî‚îÄ‚îÄ database/
    ‚îî‚îÄ‚îÄ engine.py                # AsyncEngine + SessionLocal
```

### –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

| –ó–∞–¥–∞—á–∞                       | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| ---------------------------- | -------- | --------------------------------- |
| `background_rewriter`        | 30 —Å–µ–∫   | AI-—Ä–µ—Ä–∞–π—Ç –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π     |
| `background_awaiting_closer` | 15 —Å–µ–∫   | –ó–∞–∫—Ä—ã—Ç–∏–µ orphan-–º–µ–¥–∏–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É |
| `background_post_builder`    | 3 —Å–µ–∫    | –°–±–æ—Ä–∫–∞ –ø–æ—Å—Ç–æ–≤ –∏–∑ –æ—á–µ—Ä–µ–¥–∏          |
| `background_publisher`       | 15 —Å–µ–∫   | –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–æ–≤ –≤ –∫–∞–Ω–∞–ª           |

## üß† AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä     | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ                           |
| ------------- | ------------------------------------ |
| OpenRouter    | `OPENROUTER_API_KEY`, `MODEL`        |
| DeepSeek      | `DEEPSEEK_API_KEY`, `DEEPSEEK_MODEL` |
| Google Gemini | `GEMINI_API_KEY`, `GEMINI_MODEL`     |

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã

```sql
-- –°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏
SELECT rewrite_status, COUNT(*) FROM message_queue GROUP BY rewrite_status;

-- –û–∂–∏–¥–∞—é—â–∏–µ —Ç–µ–∫—Å—Ç
SELECT * FROM message_queue WHERE awaiting_text = true;

-- –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã
SELECT id, status, scheduled_at FROM post WHERE status = 'scheduled' ORDER BY scheduled_at;

-- –û—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
SELECT id, post_error FROM post WHERE status = 'failed';
```

## üõ† –°—Ç–µ–∫

- **Telethon** ‚Äî Telegram MTProto client
- **SQLAlchemy 2.0** (async) + **asyncpg** ‚Äî ORM –∏ –¥—Ä–∞–π–≤–µ—Ä PostgreSQL
- **Alembic** ‚Äî –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **OpenAI SDK** / **Google GenAI** ‚Äî –∫–ª–∏–µ–Ω—Ç—ã AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
