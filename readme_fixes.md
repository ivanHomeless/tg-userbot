# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è

## –ü—Ä–æ–±–ª–µ–º—ã –∏–∑ –ª–æ–≥–æ–≤ (26.01.2026)

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: –ê–ª—å–±–æ–º—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ "–º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞"

**–ë—ã–ª–æ:**
```
‚úÖ –ú–µ–¥–∏–∞+—Ç–µ–∫—Å—Ç: -4983173560/44669
‚è≥ –ú–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (–∂–¥—ë–º 10—Å): -4983173560/44670  ‚Üê —á–∞—Å—Ç—å –∞–ª—å–±–æ–º–∞!
‚è≥ –ú–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (–∂–¥—ë–º 10—Å): -4983173560/44671  ‚Üê —á–∞—Å—Ç—å –∞–ª—å–±–æ–º–∞!
```

**–ü—Ä–∏—á–∏–Ω–∞:** –í –∞–ª—å–±–æ–º–∞—Ö (grouped_id) —Ç–æ–ª—å–∫–æ **–ø–µ—Ä–≤–æ–µ –º–µ–¥–∏–∞** –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–µ–∫—Å—Ç. –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ–¥–∏–∞ –≤ –∞–ª—å–±–æ–º–µ **–≤—Å–µ–≥–¥–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞** ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è Telegram!

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í collector.py

if msg.grouped_id:
    # ‚úÖ –ß–∞—Å—Ç—å –∞–ª—å–±–æ–º–∞ ‚Äî –ù–ï –∂–¥—ë–º —Ç–µ–∫—Å—Ç
    awaiting_text = False
else:
    # ‚ùå –û–¥–∏–Ω–æ—á–Ω–æ–µ –º–µ–¥–∏–∞ ‚Äî –ñ–î–Å–ú —Ç–µ–∫—Å—Ç
    awaiting_text = True
```

**–¢–µ–ø–µ—Ä—å:**
```
‚úÖ –ú–µ–¥–∏–∞+—Ç–µ–∫—Å—Ç: -4983173560/44669
üì∏ –ê–ª—å–±–æ–º: –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ): -4983173560/44670
üì∏ –ê–ª—å–±–æ–º: –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ): -4983173560/44671
```

---

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: –¢–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

**–ë—ã–ª–æ:**
```python
# Publisher –í–°–ï–ì–î–ê —Ä–∞–∑–¥–µ–ª—è–ª –º–µ–¥–∏–∞ –∏ —Ç–µ–∫—Å—Ç
await send_file(caption=None)  # –º–µ–¥–∏–∞
await send_message(text)        # —Ç–µ–∫—Å—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–∂–µ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç (100 —Å–∏–º–≤–æ–ª–æ–≤) —à—ë–ª –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º!

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞

if len(text) < CAPTION_LIMIT:
    # ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–ú–ï–°–¢–ï
    await send_file(caption=text)
else:
    # ‚ùå –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî –†–ê–ó–î–ï–õ–Ø–ï–ú
    await send_file(caption=None)
    await send_message(text)
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ .env:**
```env
# –ë–µ–∑ –ø—Ä–µ–º–∏—É–º–∞
CAPTION_LIMIT=1024

# –° –ø—Ä–µ–º–∏—É–º–æ–º
CAPTION_LIMIT=2048
```

---

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–º–∏—Ç–∞ caption

**–ë—ã–ª–æ:** –•–∞—Ä–¥–∫–æ–¥ –≤ –∫–æ–¥–µ

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `CAPTION_LIMIT` –≤ `.env`

```env
CAPTION_LIMIT=1024  # –º–µ–Ω—è–π –Ω–∞ 2048 —Å –ø—Ä–µ–º–∏—É–º–æ–º
```

---

## üìä –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (Collector)

```
–í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
‚îÇ
‚îú‚îÄ –ú–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç
‚îÇ  ‚îî‚îÄ> —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î (awaiting_text=False)
‚îÇ
‚îú‚îÄ –¢–æ–ª—å–∫–æ –º–µ–¥–∏–∞
‚îÇ  ‚îú‚îÄ grouped_id != None (–∞–ª—å–±–æ–º)
‚îÇ  ‚îÇ  ‚îî‚îÄ> —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (awaiting_text=False) ‚úÖ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ grouped_id == None (–æ–¥–∏–Ω–æ—á–Ω–æ–µ)
‚îÇ     ‚îî‚îÄ> —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (awaiting_text=True) ‚è≥ –∂–¥—ë–º 10 —Å–µ–∫
‚îÇ
‚îî‚îÄ –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
   ‚îú‚îÄ –ï—Å—Ç—å –æ–∂–∏–¥–∞—é—â–µ–µ –º–µ–¥–∏–∞?
   ‚îÇ  ‚îú‚îÄ –î–∞ ‚Üí —Å–∫–ª–µ–∏—Ç—å
   ‚îÇ  ‚îî‚îÄ –ù–µ—Ç ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç
```

### –ü—É–±–ª–∏–∫–∞—Ü–∏—è (Publisher)

```
–ì–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç
‚îÇ
‚îú‚îÄ –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
‚îÇ  ‚îî‚îÄ> send_message()
‚îÇ
‚îú‚îÄ –¢–æ–ª—å–∫–æ –º–µ–¥–∏–∞
‚îÇ  ‚îî‚îÄ> send_file() + –∞–≤—Ç–æ–ø–æ–¥–ø–∏—Å—å
‚îÇ
‚îî‚îÄ –ú–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç
   ‚îÇ
   ‚îú‚îÄ len(text) < CAPTION_LIMIT
   ‚îÇ  ‚îî‚îÄ> send_file(caption=text) ‚úÖ –≤–º–µ—Å—Ç–µ!
   ‚îÇ
   ‚îî‚îÄ len(text) >= CAPTION_LIMIT
      ‚îú‚îÄ> send_file(caption=None)
      ‚îú‚îÄ> sleep(1.5)
      ‚îî‚îÄ> send_message(text) ‚ùå —Ä–∞–∑–¥–µ–ª—è–µ–º
```

---

## üéØ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ?

### 1. `config.py`

```python
# –î–æ–±–∞–≤–ª–µ–Ω–æ
CAPTION_LIMIT = int(os.getenv("CAPTION_LIMIT", 1024))
```

### 2. `services/collector.py`

```python
async def _handle_media_without_text(self, msg, chat_id):
    if msg.grouped_id:
        # –ê–ª—å–±–æ–º ‚Äî –ù–ï –∂–¥—ë–º —Ç–µ–∫—Å—Ç
        awaiting_text = False
    else:
        # –û–¥–∏–Ω–æ—á–Ω–æ–µ –º–µ–¥–∏–∞ ‚Äî –ñ–î–Å–ú —Ç–µ–∫—Å—Ç
        awaiting_text = True
```

### 3. `services/publisher.py`

```python
async def _send_media_and_text(self, media_items, text):
    if len(text) < CAPTION_LIMIT:
        # –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç ‚Äî –≤–º–µ—Å—Ç–µ
        await send_file(caption=text)
    else:
        # –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî —Ä–∞–∑–¥–µ–ª—è–µ–º
        await send_file(caption=None)
        await send_message(text)
```

### 4. `.env`

```env
CAPTION_LIMIT=1024  # –Ω–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –¢–µ—Å—Ç 1: –û–¥–∏–Ω–æ—á–Ω–æ–µ –º–µ–¥–∏–∞ + –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç

**–í—Ö–æ–¥—è—â–µ–µ:**
- 1 —Ñ–æ—Ç–æ
- –¢–µ–∫—Å—Ç: "–¢–µ—Å—Ç" (100 —Å–∏–º–≤–æ–ª–æ–≤)

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
‚úÖ –ú–µ–¥–∏–∞+—Ç–µ–∫—Å—Ç: source/msg_id
‚Üí Publisher: üñºÔ∏èüìù –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–µ
```

---

### –¢–µ—Å—Ç 2: –û–¥–∏–Ω–æ—á–Ω–æ–µ –º–µ–¥–∏–∞ + –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç

**–í—Ö–æ–¥—è—â–µ–µ:**
- 1 —Ñ–æ—Ç–æ
- –¢–µ–∫—Å—Ç: 1500 —Å–∏–º–≤–æ–ª–æ–≤ (> CAPTION_LIMIT)

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
‚úÖ –ú–µ–¥–∏–∞+—Ç–µ–∫—Å—Ç: source/msg_id
‚Üí Publisher:
  üñºÔ∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–¥–∏–∞: 1 —Ñ–∞–π–ª–æ–≤
  üìù –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –º–µ–¥–∏–∞ (1 —á–∞—Å—Ç–µ–π, 1500 —Å–∏–º–≤)
```

---

### –¢–µ—Å—Ç 3: –ê–ª—å–±–æ–º (4 —Ñ–æ—Ç–æ) + —Ç–µ–∫—Å—Ç

**–í—Ö–æ–¥—è—â–µ–µ:**
- 1 —Ñ–æ—Ç–æ + —Ç–µ–∫—Å—Ç "–û–ø–∏—Å–∞–Ω–∏–µ"
- 3 —Ñ–æ—Ç–æ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (grouped_id –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π)

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
‚úÖ –ú–µ–¥–∏–∞+—Ç–µ–∫—Å—Ç: source/msg_1
üì∏ –ê–ª—å–±–æ–º: –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ): source/msg_2
üì∏ –ê–ª—å–±–æ–º: –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ): source/msg_3
üì∏ –ê–ª—å–±–æ–º: –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ): source/msg_4

‚Üí Processor: ‚úÖ –ê–ª—å–±–æ–º —Å–æ–±—Ä–∞–Ω: grouped_id=..., 4 —Ñ–∞–π–ª–æ–≤
‚Üí Publisher: üñºÔ∏èüìù –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–µ (–µ—Å–ª–∏ < 1024)
```

---

### –¢–µ—Å—Ç 4: –û–¥–∏–Ω–æ—á–Ω–æ–µ –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞

**–í—Ö–æ–¥—è—â–µ–µ:**
- 1 —Ñ–æ—Ç–æ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
‚è≥ –û–¥–∏–Ω–æ—á–Ω–æ–µ –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (–∂–¥—ë–º 10—Å): source/msg_id
(—á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥)
‚è∞ –ù–∞–π–¥–µ–Ω–æ 1 –º–µ–¥–∏–∞ —Å –∏—Å—Ç—ë–∫—à–∏–º –æ–∂–∏–¥–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞
üì∏ –ú–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ (—Ç–∞–π–º-–∞—É—Ç): source/msg_id

‚Üí Processor: üì∏ –ú–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
‚Üí Publisher: üñºÔ∏èüìù –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–µ
  (—Ç–µ–∫—Å—Ç = "–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –æ—Ç–≤–µ—á—É...")
```

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

```bash
# 1. –û–±–Ω–æ–≤–∏ —Ñ–∞–π–ª—ã –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
# - config.py
# - services/collector.py
# - services/publisher.py
# - .env.example

# 2. –î–æ–±–∞–≤—å –≤ .env
echo "CAPTION_LIMIT=1024" >> .env

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
python main.py
```

---

## üìù Changelog

### v2.1 (26.01.2026)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ê–ª—å–±–æ–º—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ "–æ–∂–∏–¥–∞—é—â–∏–µ —Ç–µ–∫—Å—Ç"
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –º–µ–¥–∏–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `CAPTION_LIMIT` —á–µ—Ä–µ–∑ `.env`

**–£–ª—É—á—à–µ–Ω–æ:**
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞
- ‚úÖ –õ–æ–≥–∏ –∞–ª—å–±–æ–º–æ–≤: "—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ" –≤–º–µ—Å—Ç–æ "–∂–¥—ë–º —Ç–µ–∫—Å—Ç"

---

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `AWAIT_TEXT_TIMEOUT` —á–µ—Ä–µ–∑ `.env`
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–º–µ—Å—Ç–µ/—Ä–∞–∑–¥–µ–ª—å–Ω–æ
- [ ] –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- [ ] Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—á–µ—Ä–µ–¥–∏
